type: install
version: 1.9
id: brawlgpt-app
name: BrawlGPT - AI Brawl Stars Coach
categories:
  - apps/dev-and-admin-tools
  - apps/popular
  - apps/content-management
homepage: https://github.com/san2stic/BrawlGPT
logo: https://raw.githubusercontent.com/san2stic/BrawlGPT/main/logo.png
description: |
  AI-powered coaching and statistics platform for Brawl Stars players.
  
  Features:
  - Player search and detailed statistics
  - AI-powered coaching with personalized tips
  - Battle log analysis and player interaction graph
  - Meta analysis and trend detection
  - Fast performance with Redis caching
  
  Tech Stack: FastAPI, React 19, PostgreSQL, Redis

settings:
  fields:
    - type: string
      name: brawlApiKey
      caption: Brawl Stars API Key
      placeholder: Your API key from developer.brawlstars.com
      required: true
      
    - type: string
      name: openrouterApiKey
      caption: OpenRouter API Key
      placeholder: Your API key from openrouter.ai
      required: true
      inputType: password
      
    - type: string
      name: jwtSecret
      caption: JWT Secret Key
      placeholder: Minimum 32 characters secret key
      required: true
      inputType: password
      default: ${fn.password(32)}
      
    - type: string
      name: customDomain
      caption: Custom Domain (optional)
      placeholder: brawlgpt.yourdomain.com
      required: false

nodes:
  # PostgreSQL Database
  - nodeType: dockerengine
    nodeGroup: postgres
    displayName: PostgreSQL Database
    count: 1
    fixedCloudlets: 1
    flexibleCloudlets: 4
    env:
      POSTGRES_USER: brawl_user
      POSTGRES_PASSWORD: ${fn.password(16)}
      POSTGRES_DB: brawlgpt_db
    volumes:
      - /var/lib/postgresql/data
    docker:
      image: postgres:15-alpine
      cmd: postgres
    restart: always

  # Redis Cache
  - nodeType: dockerengine
    nodeGroup: redis
    displayName: Redis Cache
    count: 1
    fixedCloudlets: 1
    flexibleCloudlets: 2
    volumes:
      - /data
    docker:
      image: redis:7-alpine
      cmd: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: always

  # Backend API
  - nodeType: dockerengine
    nodeGroup: backend
    displayName: Backend API
    count: 1
    fixedCloudlets: 1
    flexibleCloudlets: 8
    env:
      BRAWL_API_KEY: ${settings.brawlApiKey}
      OPENROUTER_API_KEY: ${settings.openrouterApiKey}
      SECRET_KEY: ${settings.jwtSecret}
      DATABASE_URL: postgresql+asyncpg://brawl_user:${nodes.postgres.env.POSTGRES_PASSWORD}@${nodes.postgres.address}:5432/brawlgpt_db
      REDIS_URL: redis://${nodes.redis.address}:6379/0
      ALLOWED_ORIGINS: https://${env.domain},http://${env.domain}
      LOG_LEVEL: INFO
      DEBUG: false
    volumes:
      - /app
    docker:
      image: python:3.12-slim
      cmd: sleep infinity
    restart: always

  # Frontend
  - nodeType: dockerengine
    nodeGroup: frontend
    displayName: Frontend Web UI
    count: 1
    fixedCloudlets: 1
    flexibleCloudlets: 4
    env:
      VITE_API_URL: https://${env.domain}
    volumes:
      - /app
    docker:
      image: nginx:alpine
      cmd: sleep infinity
    restart: always

  # Nginx Reverse Proxy
  - nodeType: nginx
    nodeGroup: nginx
    displayName: Web Server
    count: 1
    fixedCloudlets: 1
    flexibleCloudlets: 2
    cloudlets: 4

onInstall:
  - log: "Starting BrawlGPT installation..."
  
  # Wait for PostgreSQL to be ready first
  - log: "Waiting for PostgreSQL to be ready..."
  - sleep: 10000
  - cmd[postgres]: "pg_isready -U brawl_user -d brawlgpt_db"
  
  # Clone repository to backend node and install
  - log: "Installing git and build tools on backend..."
  - cmd[backend]: "apt-get update && apt-get install -y --no-install-recommends git build-essential curl"
  
  - log: "Cloning repository to backend..."
  - cmd[backend]: "git clone https://github.com/san2stic/BrawlGPT.git /app"
  
  - log: "Installing Python dependencies..."
  - cmd[backend]: "cd /app/backend && pip install --no-cache-dir --upgrade pip && pip install --no-cache-dir -r requirements.txt"
  
  # Clone repository to frontend node and build
  - log: "Installing git and node on frontend..."
  - cmd[frontend]: "apk add --no-cache git nodejs npm"
  
  - log: "Cloning repository to frontend..."
  - cmd[frontend]: "git clone https://github.com/san2stic/BrawlGPT.git /tmp/brawlgpt"
  
  - log: "Building frontend application..."
  - cmd[frontend]: "cd /tmp/brawlgpt/frontend && npm ci && VITE_API_URL=https://${env.domain} npm run build"
  
  - log: "Deploying frontend to nginx..."
  - cmd[frontend]: "rm -rf /usr/share/nginx/html/* && cp -r /tmp/brawlgpt/frontend/dist/* /usr/share/nginx/html/"
  
  - log: "Configuring frontend nginx..."
  - cmd[frontend]: "cp /tmp/brawlgpt/frontend/nginx.conf /etc/nginx/conf.d/default.conf"
  
  - log: "Cleaning up frontend temp files..."
  - cmd[frontend]: "rm -rf /tmp/brawlgpt"
  
  # Start backend application
  - log: "Starting backend application..."
  - cmd[backend]: "cd /app/backend && nohup uvicorn main:app --host 0.0.0.0 --port 8000 > /app/backend/app.log 2>&1 &"
  
  - log: "Waiting for backend to start..."
  - sleep: 5000
  
  # Start frontend nginx
  - log: "Starting frontend nginx..."
  - cmd[frontend]: "nginx"
  
  # Configure Nginx reverse proxy
  - log: "Configuring Nginx reverse proxy..."
  - cmd[nginx]: |
      cat > /etc/nginx/conf.d/brawlgpt.conf <<'EOF'
      upstream backend {
          server ${nodes.backend.address}:8000;
      }
      
      upstream frontend {
          server ${nodes.frontend.address}:80;
      }
      
      server {
          listen 80;
          server_name ${env.domain};
          client_max_body_size 50M;
          
          # Frontend
          location / {
              proxy_pass http://frontend;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
          }
          
          # Backend API
          location /api/ {
              proxy_pass http://backend;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
          }
          
          # Health checks
          location /health {
              proxy_pass http://backend;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
          }
      }
      EOF
      nginx -s reload
  
  # Configure custom domain SSL if provided
  - if (${settings.customDomain:}):
      - api: environment.binder.BindSSL
        envName: ${env.name}
        certType: CUSTOM
        extDomains: ${settings.customDomain}
  
  - log: "BrawlGPT installation completed!"
  - log: "Access your application at: https://${env.domain}"

success: |
  # ðŸŽ® BrawlGPT Successfully Deployed!
  
  Your AI-powered Brawl Stars coaching platform is ready!
  
  ## Access Information
  - **Application URL**: https://${env.domain}
  - **API Documentation**: https://${env.domain}/docs
  - **Health Check**: https://${env.domain}/health
  
  ## Next Steps
  1. Visit the application URL to start using BrawlGPT
  2. Search for any Brawl Stars player by their tag
  3. Get AI-powered coaching and insights
  
  ## Database Information
  - **PostgreSQL**: Running on ${nodes.postgres.address}:5432
  - **Redis Cache**: Running on ${nodes.redis.address}:6379
  - **Database Name**: brawlgpt_db
  - **Database User**: brawl_user
  
  ## Configuration
  Your API keys have been securely configured:
  - Brawl Stars API: Configured âœ“
  - OpenRouter API: Configured âœ“
  - JWT Secret: Auto-generated âœ“
  
  ## Support
  - Documentation: https://github.com/san2stic/BrawlGPT
  - Issues: https://github.com/san2stic/BrawlGPT/issues
  
  Enjoy your BrawlGPT experience! ðŸš€
